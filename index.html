<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ICU Stock Dashboard (Local Upload)</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- XLSX parsing + Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.29/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>

<body class="min-h-screen text-slate-100
bg-[radial-gradient(1200px_600px_at_10%_-10%,rgba(59,130,246,0.30),transparent_60%),radial-gradient(900px_500px_at_90%_0%,rgba(34,197,94,0.20),transparent_55%),radial-gradient(900px_500px_at_40%_110%,rgba(244,63,94,0.18),transparent_55%),linear-gradient(180deg,#020617,#0b1220,#020617)]">

  <!-- HEADER -->
  <div class="sticky top-0 z-30 backdrop-blur bg-slate-950/70 border-b border-white/10">
    <div class="px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3 min-w-0">
        <div class="w-2.5 h-2.5 rounded-full bg-blue-500 shadow-[0_0_18px_rgba(59,130,246,0.9)]"></div>
        <div class="font-extrabold tracking-wide truncate">ICU Stock Dashboard</div>
        <div id="pillStatus" class="text-xs px-2 py-1 rounded-full border border-white/10 bg-white/5 text-slate-300 font-bold">Ready</div>
        <div id="pillSelected" class="hidden md:inline text-xs px-2 py-1 rounded-full border border-white/10 bg-white/5 text-slate-300 font-bold">‚Äî</div>
      </div>

      <div class="flex items-center gap-2 flex-wrap justify-end">
        <button class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 font-extrabold" onclick="openOrganizer()">Organize</button>

        <button class="px-3 py-2 rounded-xl border border-emerald-400/30 bg-emerald-500/10 hover:bg-emerald-500/15 font-extrabold" onclick="exportAllExcel()">Export All (Excel)</button>
        <button class="px-3 py-2 rounded-xl border border-emerald-400/30 bg-emerald-500/10 hover:bg-emerald-500/15 font-extrabold" onclick="exportAllPDF()">Export All (PDF)</button>

        <button class="px-3 py-2 rounded-xl border border-amber-400/30 bg-amber-500/10 hover:bg-amber-500/15 font-extrabold" onclick="exportZeroExcel()">Export Zero (Excel)</button>
        <button class="px-3 py-2 rounded-xl border border-amber-400/30 bg-amber-500/10 hover:bg-amber-500/15 font-extrabold" onclick="exportZeroPDF()">Export Zero (PDF)</button>

        <button id="btnUndo" class="px-3 py-2 rounded-xl border border-rose-400/30 bg-rose-500/10 hover:bg-rose-500/15 font-extrabold disabled:opacity-50" onclick="undoLast()" disabled>Undo</button>

        <button class="px-3 py-2 rounded-xl border border-pink-400/30 bg-pink-500/10 hover:bg-pink-500/15 font-extrabold" onclick="toggleFavoritesPanel()">Favorites</button>
      </div>
    </div>

    <!-- VIEW TABS -->
    <div class="px-4 pb-3 flex flex-wrap gap-2 items-center justify-between">
      <div class="flex gap-2 flex-wrap">
        <button id="viewBtnItems" class="px-3 py-2 rounded-xl font-extrabold border border-blue-400/30 bg-blue-500/15 hover:bg-blue-500/20" onclick="switchView('ITEMS')">Items</button>
        <button id="viewBtnZero" class="px-3 py-2 rounded-xl font-extrabold border border-white/10 bg-white/5 hover:bg-white/10" onclick="switchView('ZERO')">
          Zero Stock <span id="zeroCountBadge" class="ml-2 text-xs px-2 py-0.5 rounded-full border border-white/10 bg-black/20">0</span>
        </button>
      </div>

      <!-- CONTROLS -->
      <div id="itemsControls" class="flex flex-col md:flex-row gap-3 md:items-center md:justify-between w-full mt-3">
        <!-- GLOBAL SEARCH -->
        <div class="flex-1 md:max-w-xl">
          <input id="searchBox" type="text"
                 class="w-full px-4 py-2 rounded-2xl border border-white/10 bg-white/5 focus:outline-none focus:ring-2 focus:ring-blue-500/40"
                 placeholder="Search by name, code, or category‚Ä¶"
                 oninput="renderMain()" />
        </div>

        <div class="flex gap-2 flex-wrap">
          <button class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 font-extrabold" onclick="clearSearch()">Clear</button>
        </div>
      </div>
    </div>

    <!-- CATEGORY BAR -->
    <div id="categoryWrap" class="px-4 pb-3">
      <div id="catBar" class="flex flex-wrap gap-2 pb-2"></div>
      <div id="metaLine" class="mt-2 text-xs text-slate-300/80 font-semibold">Upload your stock file to start.</div>
    </div>
  </div>

  <!-- MAIN -->
  <div id="app" class="px-4 py-4">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">

      <!-- LEFT -->
      <div class="lg:col-span-4 rounded-3xl border border-white/10 bg-white/5 p-4 shadow-xl">
        <div class="font-extrabold text-base">Stock File (XLS/XLSX/HTML-xls)</div>
        <div class="text-sm text-slate-300 mt-1">
          This version is <span class="font-extrabold text-slate-100">NOT linked to Google Sheets</span>.
          The dashboard depends only on the uploaded stock file and saves data locally in this browser.
        </div>

        <div class="mt-4 grid gap-3">
          <input id="xlsFile" type="file" accept=".xls,.xlsx"
                 class="w-full px-4 py-2 rounded-2xl border border-white/10 bg-white/5">
          <button class="px-4 py-2 rounded-2xl border border-blue-400/30 bg-blue-500/15 hover:bg-blue-500/20 font-extrabold" onclick="importStockFile()">
            Upload & Auto-Categorize
          </button>

          <div class="flex gap-2 flex-wrap">
            <button class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 font-extrabold" onclick="resetLocalData()">Reset Local Data</button>
            <button class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 font-extrabold" onclick="downloadBackupJson()">Backup JSON</button>
            <label class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 font-extrabold cursor-pointer">
              Restore JSON
              <input id="restoreJsonFile" type="file" accept=".json" class="hidden" onchange="restoreBackupJson(this.files?.[0])">
            </label>
          </div>

          <div id="lastMeta" class="text-xs text-slate-300/80 font-semibold">‚Äî</div>
        </div>

        <div class="mt-4 rounded-2xl border border-white/10 bg-black/20 p-3">
          <div class="font-extrabold">Notes</div>
          <ul class="text-sm text-slate-300 mt-2 list-disc pl-5 space-y-1">
            <li>‚ù§Ô∏è Favorites are saved in this browser (localStorage).</li>
            <li><span class="font-extrabold text-slate-100">Copy</span> deducts Qty (-1) automatically.</li>
            <li><span class="font-extrabold text-slate-100">Undo</span> restores the last deducted item.</li>
            <li>Auto-categorization uses rules based on <span class="font-extrabold">item name + code</span>.</li>
            <li>You can move any item to another category (dropdown) and rename/add categories from <span class="font-extrabold">Organize</span>.</li>
            <li>Zero Stock view shows items with Qty = 0.</li>
          </ul>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="lg:col-span-8 rounded-3xl border border-white/10 bg-white/5 p-4 shadow-xl">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div id="rightTitle" class="text-base font-extrabold truncate">Items</div>
            <div id="rightSub" class="text-sm text-slate-300">Upload stock file to load items.</div>
          </div>
        </div>

        <!-- ITEMS VIEW -->
        <div id="viewItems" class="mt-4">
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="text-slate-300/80">
                <tr class="border-b border-white/10">
                  <th class="py-2 px-2 text-left w-16">Sticker</th>
                  <th class="py-2 px-2 text-left w-10">Fav</th>
                  <th class="py-2 px-2 text-left w-52">Item Code</th>
                  <th class="py-2 px-2 text-left">Item Name</th>
                  <th class="py-2 px-2 text-left w-72">Category</th>
                  <th class="py-2 px-2 text-left w-28">Qty</th>
                  <th class="py-2 px-2 text-left w-28">Action</th>
                </tr>
              </thead>
              <tbody id="itemsBody"></tbody>
            </table>
          </div>
          <div id="emptyState" class="hidden mt-6 text-slate-300 font-semibold">No items found.</div>
        </div>

        <!-- ZERO VIEW -->
        <div id="viewZero" class="hidden mt-4">
          <div class="flex items-center justify-between gap-3">
            <div class="font-extrabold">Zero Stock Items</div>
            <button class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 font-extrabold" onclick="renderZeroStock()">Refresh List</button>
          </div>
          <div class="mt-3 text-sm text-slate-300">Shows items with Qty = 0.</div>

          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="text-slate-300/80">
                <tr class="border-b border-white/10">
                  <th class="py-2 px-2 text-left w-20">Sticker</th>
                  <th class="py-2 px-2 text-left">Category</th>
                  <th class="py-2 px-2 text-left w-56">Item Code</th>
                  <th class="py-2 px-2 text-left">Item Name</th>
                  <th class="py-2 px-2 text-left w-28">Copy</th>
                </tr>
              </thead>
              <tbody id="zeroBody"></tbody>
            </table>
          </div>

          <div id="zeroEmpty" class="hidden mt-6 text-slate-300 font-semibold">No zero-stock items.</div>
        </div>

      </div>
    </div>
  </div>

  <!-- FAVORITES PANEL -->
  <div id="favPanel" class="fixed inset-y-0 right-0 w-full sm:w-[440px] z-40 hidden">
    <div class="h-full bg-slate-950/80 backdrop-blur border-l border-white/10 shadow-2xl p-4 flex flex-col">
      <div class="flex items-center justify-between gap-3">
        <div class="font-extrabold text-lg">Favorites</div>
        <button class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 font-extrabold" onclick="toggleFavoritesPanel()">Close</button>
      </div>

      <div class="mt-3">
        <input id="favSearch" class="w-full px-4 py-2 rounded-2xl border border-white/10 bg-white/5 focus:outline-none"
               placeholder="Search favorites by name/code‚Ä¶" oninput="renderFavorites()">
      </div>

      <div class="mt-4 flex-1 overflow-auto">
        <div id="favList" class="space-y-2"></div>
      </div>

      <div class="mt-3 text-xs text-slate-400">
        Favorites are saved in this browser (localStorage).
      </div>
    </div>
  </div>

  <!-- ORGANIZER MODAL -->
  <div id="orgModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60" onclick="closeOrganizer()"></div>

    <div class="absolute inset-2 sm:inset-4 mx-auto w-[calc(100vw-1rem)] sm:w-[calc(100vw-2rem)] max-w-none">
      <div class="rounded-3xl border border-white/10 bg-slate-950/85 backdrop-blur shadow-2xl overflow-hidden h-[calc(100vh-1rem)] sm:h-[calc(100vh-2rem)] flex flex-col">
        <div class="px-4 py-3 border-b border-white/10 flex items-center justify-between gap-3">
          <div class="font-extrabold">Organizer (Categories & Items)</div>
          <div class="flex items-center gap-2"><span id="orgSavedPill" class="hidden px-2 py-1 rounded-xl text-xs border border-emerald-400/30 bg-emerald-500/10">Saved ‚úÖ</span><button class="px-3 py-2 rounded-xl border border-emerald-400/20 bg-emerald-500/10 hover:bg-emerald-500/20 font-extrabold" onclick="saveOrganizerNow()">Save</button><button class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 font-extrabold" onclick="closeOrganizer()">Close</button></div>
        </div>

        <div class="flex-1 overflow-auto">
        <div class="p-4 grid grid-cols-1 md:grid-cols-12 gap-4">
          <!-- Categories -->
          <div class="md:col-span-4 rounded-2xl border border-white/10 bg-white/5 p-3">
            <div class="flex items-center justify-between gap-2">
              <div class="font-extrabold">Categories</div>
              <button class="px-3 py-2 rounded-xl border border-blue-400/30 bg-blue-500/15 hover:bg-blue-500/20 font-extrabold" onclick="addCategory()">+ Add</button>
            </div>

            <div class="mt-3">
              <input id="orgCatSearch" class="w-full px-3 py-2 rounded-2xl border border-white/10 bg-black/20 focus:outline-none"
                     placeholder="Search categories‚Ä¶" oninput="renderOrganizer()">
            </div>

            <div class="mt-3 max-h-[55vh] overflow-auto scrollbar-hide">
              <div id="orgCatList" class="space-y-2"></div>
            </div>
          </div>

          <!-- Items in selected category -->
          <div class="md:col-span-8 rounded-2xl border border-white/10 bg-white/5 p-3">
            <div class="flex flex-wrap items-center justify-between gap-2">
              <div class="font-extrabold">
                Items in: <span id="orgCatTitle" class="text-slate-200">‚Äî</span>
              </div>
              <div class="flex gap-2 flex-wrap">
                <input id="orgItemSearch" class="px-3 py-2 rounded-2xl border border-white/10 bg-black/20 focus:outline-none"
                       placeholder="Search items‚Ä¶" oninput="renderOrganizer()">
              </div>
            </div>

            <div class="mt-3 overflow-x-auto max-h-[55vh] overflow-y-auto scrollbar-hide">
              <table class="w-full text-sm">
                <thead class="text-slate-300/80 sticky top-0 bg-slate-950/70">
                  <tr class="border-b border-white/10">
                    <th class="py-2 px-2 text-left w-14">‚≠ê</th>
                    <th class="py-2 px-2 text-left w-56">Code</th>
                    <th class="py-2 px-2 text-left">Name</th>
                    <th class="py-2 px-2 text-left w-28">Qty</th>
                    <th class="py-2 px-2 text-left w-56">Move to</th>
                  </tr>
                </thead>
                <tbody id="orgItemsBody"></tbody>
              </table>
              <div id="orgEmpty" class="hidden mt-4 text-slate-300 font-semibold">No items in this category.</div>
            </div>

            <div class="mt-3 text-xs text-slate-300/80 font-semibold">
              Tip: Use this window to reorganize categories and move items easily.
            </div>
          </div>
        </div>


        </div> <!-- /p-4 grid -->
      </div> <!-- /scroll area -->

      <div class="px-4 py-3 border-t border-white/10 flex items-center justify-between gap-2 bg-black/20">
        <div class="text-xs opacity-80">All changes are saved immediately and reflected in the main view.</div>
        <div class="flex items-center gap-2">
          <button class="px-3 py-2 rounded-xl border border-emerald-400/20 bg-emerald-500/10 hover:bg-emerald-500/20 font-extrabold" onclick="saveOrganizerNow()">Save</button>
          <button class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 font-extrabold" onclick="closeOrganizer()">Done</button>
        </div>
      </div>

      </div>

    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="fixed right-4 bottom-4 hidden max-w-[560px] rounded-2xl border border-white/10 bg-slate-900/90 backdrop-blur px-4 py-3 shadow-2xl font-extrabold"></div>

<script>
  // =========================================
  // LOCAL STORAGE KEYS
  // =========================================
  const LS_ITEMS   = "ICU_STOCK_ITEMS_V2";
  const LS_META    = "ICU_STOCK_META_V2";
  const LS_FAV     = "ICU_STOCK_FAV_V2";
  const LS_UNDO    = "ICU_STOCK_UNDO_V2";

  // =========================================
  // STATE
  // =========================================
  let items = [];              // [{code,name,qty,category}]
  let selectedCategory = "__ALL__";
  let currentView = "ITEMS";
  let favSet = new Set();
  let undoStack = [];          // [{key, prevQty, newQty}]
  let orgSelectedCategory = ""; // for organizer

  // =========================================
  // HELPERS
  // =========================================
  function norm(s){ return String(s||"").trim().toLowerCase(); }
  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.remove("hidden");
    setTimeout(() => t.classList.add("hidden"), 2200);
  }
  function setStatus(s){ document.getElementById("pillStatus").textContent = s; }

  function itemKey(it){
    const c = norm(it.code);
    if(c) return "CODE:" + c;
    return "NAME:" + norm(it.name);
  }

  function loadState(){
    try{
      items = JSON.parse(localStorage.getItem(LS_ITEMS) || "[]") || [];
    }catch(e){ items = []; }

    try{
      const arr = JSON.parse(localStorage.getItem(LS_FAV) || "[]") || [];
      favSet = new Set(arr);
    }catch(e){ favSet = new Set(); }

    try{
      undoStack = JSON.parse(localStorage.getItem(LS_UNDO) || "[]") || [];
    }catch(e){ undoStack = []; }

    updateUndoBtn();
    updateMetaLine();
    try{ if(!document.getElementById('orgModal')?.classList.contains('hidden')) showOrgSaved(); }catch(e){}
  }

  function persistState(){
    localStorage.setItem(LS_ITEMS, JSON.stringify(items));
    localStorage.setItem(LS_FAV, JSON.stringify(Array.from(favSet)));
    localStorage.setItem(LS_UNDO, JSON.stringify(undoStack));
    updateMetaLine();
    try{ if(!document.getElementById('orgModal')?.classList.contains('hidden')) showOrgSaved(); }catch(e){}
  }
  function showOrgSaved(){
    const pill = document.getElementById("orgSavedPill");
    if(!pill) return;
    pill.classList.remove("hidden");
    clearTimeout(showOrgSaved._t);
    showOrgSaved._t = setTimeout(()=> pill.classList.add("hidden"), 1400);
  }

  function saveOrganizerNow(){
    // Force-save + refresh all views
    persistState();
    renderCategoryBar();
    renderMain();
    renderZeroStock();
    if(!document.getElementById("orgModal").classList.contains("hidden")){
      renderOrganizer();
      showOrgSaved();
    }
    toast("Saved ‚úÖ");
  }


  function updateUndoBtn(){
    const btn = document.getElementById("btnUndo");
    btn.disabled = !undoStack.length;
  }

  // =========================================
  // CATEGORY STYLES + STICKERS (same idea)
  // =========================================
  const CAT_PALETTE = [
    { bg:"rgba(59,130,246,0.22)", bd:"rgba(59,130,246,0.55)", glow:"rgba(59,130,246,0.35)" },
    { bg:"rgba(34,197,94,0.18)",  bd:"rgba(34,197,94,0.55)",  glow:"rgba(34,197,94,0.30)" },
    { bg:"rgba(244,63,94,0.16)",  bd:"rgba(244,63,94,0.55)",  glow:"rgba(244,63,94,0.30)" },
    { bg:"rgba(245,158,11,0.18)", bd:"rgba(245,158,11,0.55)", glow:"rgba(245,158,11,0.30)" },
    { bg:"rgba(168,85,247,0.18)", bd:"rgba(168,85,247,0.55)", glow:"rgba(168,85,247,0.30)" },
    { bg:"rgba(20,184,166,0.18)", bd:"rgba(20,184,166,0.55)", glow:"rgba(20,184,166,0.30)" },
    { bg:"rgba(14,165,233,0.18)", bd:"rgba(14,165,233,0.55)", glow:"rgba(14,165,233,0.30)" },
    { bg:"rgba(236,72,153,0.16)", bd:"rgba(236,72,153,0.55)", glow:"rgba(236,72,153,0.30)" },
  ];
  function hashStyleForCategory(catName){
    const s = String(catName || "");
    let h = 0;
    for(let i=0;i<s.length;i++) h = (h * 31 + s.charCodeAt(i)) >>> 0;
    return CAT_PALETTE[h % CAT_PALETTE.length];
  }

  function stickerForCategory(cat){
    const c = norm(cat);
    if(c.includes("iv") || c.includes("cannula")) return "üß™";
    if(c.includes("syringe")) return "üíâ";
    if(c.includes("mask") || c.includes("ppe")) return "üò∑";
    if(c.includes("glove")) return "üß§";
    if(c.includes("airway") || c.includes("tube") || c.includes("resp")) return "ü´Å";
    if(c.includes("dressing") || c.includes("gauze") || c.includes("bandage")) return "ü©π";
    if(c.includes("catheter") || c.includes("urine")) return "üßª";
    if(c.includes("lab") || c.includes("sample")) return "üß¨";
    if(c.includes("med")) return "üíä";
    return "‚≠ê";
  }
  function stickerForItem(it){
    const n = norm(it.name);
    if(n.includes("syringe")) return "üíâ";
    if(n.includes("glove")) return "üß§";
    if(n.includes("mask")) return "üò∑";
    if(n.includes("gauze") || n.includes("dressing") || n.includes("bandage")) return "ü©π";
    if(n.includes("catheter")) return "üßª";
    if(n.includes("iv") || n.includes("cannula")) return "üß™";
    if(n.includes("needle")) return "üìå";
    if(n.includes("vial") || n.includes("amp") || n.includes("tablet") || n.includes("drug")) return "üíä";
    return "‚ú®";
  }

  // =========================================
  // AUTO CATEGORY RULES (name + code)
  // =========================================
  const AUTO_CAT_RULES = [
    { cat: "IV & Cannula", keys: ["iv", "cannula", "venflon", "branula", "angiocath"] },
    { cat: "Syringes & Needles", keys: ["syringe", "needle", "scalp vein", "butterfly"] },
    { cat: "PPE", keys: ["mask", "n95", "glove", "gown", "cap", "shoe cover", "apron", "face shield"] },
    { cat: "Dressings", keys: ["gauze", "bandage", "dressing", "tape", "plaster", "swab"] },
    { cat: "Airway & Respiratory", keys: ["ett", "endotracheal", "trache", "tracheostomy", "ambu", "neb", "nebul", "oxygen", "venturi", "hme", "filter", "circuit"] },
    { cat: "Suction", keys: ["suction", "yankauer", "suction catheter", "sputum"] },
    { cat: "Urinary", keys: ["foley", "urine", "urinary", "uro", "urine bag", "u bag"] },
    { cat: "NG/Feeding", keys: ["ng", "ryle", "feeding", "peg", "gastro", "tube feeding"] },
    { cat: "Lines & Central", keys: ["cvc", "central line", "triple lumen", "introducer", "arterial line"] },
    { cat: "Lab & Sampling", keys: ["vacutainer", "edta", "citrate", "serum", "container", "specimen", "culture"] },
    { cat: "Medications", keys: ["amp", "ampoule", "vial", "tab", "tablet", "capsule", "inj", "infusion", "solution"] },
    { cat: "Disinfection", keys: ["alcohol", "chlorhex", "betadine", "iodine", "sanitizer", "disinfect"] },
  ];

  function cleanText(s){
    return String(s || "")
      .toLowerCase()
      .replace(/[^a-z0-9\s]/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function autoCategory(code, name){
    const t = cleanText((name||"") + " " + (code||""));
    if(!t) return "Uncategorized";
    for(const r of AUTO_CAT_RULES){
      for(const k of r.keys){
        if(t.includes(cleanText(k))) return r.cat;
      }
    }
    return "Other / Review";
  }

  // =========================================
  // FILE IMPORT (XLS/XLSX + HTML-xls)
  // =========================================
  async function importStockFile(){
    const f = document.getElementById("xlsFile").files?.[0];
    if(!f){ toast("Please choose a stock file"); return; }

    setStatus("Importing‚Ä¶");

    try{
      const buf = await f.arrayBuffer();
      // detect if it's actually HTML (many .xls files are HTML tables)
      const head = new TextDecoder("utf-8").decode(buf.slice(0, 64));
      let rows = [];

      if(head.trim().startsWith("<")){
        // HTML table
        const text = new TextDecoder("utf-8").decode(buf);
        rows = parseHtmlXls(text);
      } else {
        // real Excel
        rows = parseExcelXls(buf);
      }

      if(!rows.length){
        setStatus("Ready");
        toast("No rows detected. Please check file format.");
        return;
      }

      // Build items
      const parsed = rowsToItems(rows);

      if(!parsed.items.length){
        setStatus("Ready");
        toast("Could not detect Item Code / Item Name / Qty columns.");
        return;
      }

      items = parsed.items;

      // Save meta
      const meta = {
        fileName: f.name,
        rowsCount: rows.length,
        importedAtISO: new Date().toISOString(),
        detected: parsed.detected
      };
      localStorage.setItem(LS_META, JSON.stringify(meta));

      // reset category selection to ALL
      selectedCategory = "__ALL__";
      orgSelectedCategory = "";

      // keep favorites but remove keys that don't exist (optional)
      const liveKeys = new Set(items.map(itemKey));
      favSet = new Set(Array.from(favSet).filter(k => liveKeys.has(k)));

      // clear undo
      undoStack = [];
      persistState();
      updateUndoBtn();

      updateLastMetaUI();
      ensureCategorySelected(true);
      renderCategoryBar();
      renderMain();
      renderZeroStock();

      setStatus("Ready");
      toast("Imported ‚úÖ Auto-categorized ‚úÖ");

    }catch(err){
      console.error(err);
      setStatus("Ready");
      toast("Import error: " + (err?.message || err));
    }
  }

  function parseExcelXls(arrayBuffer){
    const wb = XLSX.read(arrayBuffer, { type: "array" });
    const sheetName = wb.SheetNames?.[0];
    const ws = wb.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, defval: "" });
    return rows.filter(r => r && r.some(v => String(v).trim() !== ""));
  }

  function parseHtmlXls(htmlText){
    // Extract first <table> and convert to rows
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlText, "text/html");
    const table = doc.querySelector("table");
    if(!table) return [];
    const rows = [];
    table.querySelectorAll("tr").forEach(tr => {
      const cells = [];
      tr.querySelectorAll("th,td").forEach(td => cells.push(td.textContent?.trim() ?? ""));
      // keep only non-empty rows
      if(cells.some(v => String(v).trim() !== "")) rows.push(cells);
    });
    return rows;
  }

  function guessHeaderRow(rows){
    // find first row that contains two of: "item", "code", "name", "qty", "piece", "pack"
    let bestIdx = 0, bestScore = -1;
    for(let i=0;i<Math.min(rows.length, 25);i++){
      const r = rows[i].map(x => norm(x));
      let score = 0;
      for(const c of r){
        if(c.includes("item")) score++;
        if(c.includes("code")) score++;
        if(c.includes("name")) score++;
        if(c.includes("qty") || c.includes("quantity")) score++;
        if(c.includes("piece")) score++;
        if(c.includes("pack")) score++;
      }
      if(score > bestScore){
        bestScore = score;
        bestIdx = i;
      }
    }
    return bestIdx;
  }

  function rowsToItems(rows){
    const headerIdx = guessHeaderRow(rows);
    const header = rows[headerIdx].map(h => String(h||"").trim());
    const dataRows = rows.slice(headerIdx + 1);

    // map column indices
    const headerNorm = header.map(h => norm(h));
    const findCol = (preds) => {
      for(let i=0;i<headerNorm.length;i++){
        const h = headerNorm[i];
        for(const p of preds){
          if(h.includes(p)) return i;
        }
      }
      return -1;
    };

    const colItemCode = findCol(["item code","code"]);
    const colItemName = findCol(["item name","name"]);
    // qty: prefer pieceqty > qty > quantity > packqty
    let colQty = -1;
    const candidates = [
      ["pieceqty","piece qty","piece"],
      ["qty","quantity"],
      ["packqty","pack qty","pack"]
    ];
    for(const preds of candidates){
      colQty = findCol(preds);
      if(colQty !== -1) break;
    }

    const detected = { headerIdx, header, colItemCode, colItemName, colQty };

    const out = [];
    for(const r of dataRows){
      const code = (colItemCode>=0 ? r[colItemCode] : "") ?? "";
      const name = (colItemName>=0 ? r[colItemName] : "") ?? "";
      if(!String(code).trim() && !String(name).trim()) continue;

      let qtyRaw = (colQty>=0 ? r[colQty] : 0);
      let qty = Number(String(qtyRaw).replace(/,/g,"").trim());
      if(!Number.isFinite(qty)) qty = 0;

      const cat = autoCategory(code, name);

      out.push({
        code: String(code||"").trim(),
        name: String(name||"").trim(),
        qty: Math.max(0, Math.round(qty)),
        category: cat
      });
    }

    // merge duplicates by code (or name if code empty)
    const map = new Map();
    for(const it of out){
      const k = itemKey(it);
      if(!map.has(k)) map.set(k, it);
      else map.get(k).qty += (it.qty || 0);
    }

    return { items: Array.from(map.values()), detected };
  }

  function updateLastMetaUI(){
    const el = document.getElementById("lastMeta");
    const meta = safeJson(localStorage.getItem(LS_META));
    if(!meta){
      el.textContent = "No stock file uploaded yet.";
      return;
    }
    el.textContent = `Last file: ${meta.fileName || "‚Äî"} ‚Ä¢ Rows: ${meta.rowsCount || "‚Äî"} ‚Ä¢ Imported: ${meta.importedAtISO || "‚Äî"}`;
  }

  function safeJson(s){
    try{ return JSON.parse(s||""); }catch(e){ return null; }
  }

  function updateMetaLine(){
    const meta = safeJson(localStorage.getItem(LS_META));
    const el = document.getElementById("metaLine");
    if(!el) return;
    if(!meta){
      el.textContent = "Upload your stock file to start.";
      return;
    }
    el.textContent = `File: ${meta.fileName || "‚Äî"} ‚Ä¢ Items: ${items.length} ‚Ä¢ Imported: ${meta.importedAtISO || "‚Äî"}`;
  }

  // =========================================
  // VIEW SWITCH
  // =========================================
  function switchView(v){
    currentView = v;

    const btnItems = document.getElementById("viewBtnItems");
    const btnZero  = document.getElementById("viewBtnZero");

    btnItems.className = v==="ITEMS"
      ? "px-3 py-2 rounded-xl font-extrabold border border-blue-400/30 bg-blue-500/15 hover:bg-blue-500/20"
      : "px-3 py-2 rounded-xl font-extrabold border border-white/10 bg-white/5 hover:bg-white/10";

    btnZero.className = v==="ZERO"
      ? "px-3 py-2 rounded-xl font-extrabold border border-blue-400/30 bg-blue-500/15 hover:bg-blue-500/20"
      : "px-3 py-2 rounded-xl font-extrabold border border-white/10 bg-white/5 hover:bg-white/10";

    document.getElementById("itemsControls").classList.toggle("hidden", v !== "ITEMS");
    document.getElementById("categoryWrap").classList.toggle("hidden", v !== "ITEMS");

    document.getElementById("viewItems").classList.toggle("hidden", v !== "ITEMS");
    document.getElementById("viewZero").classList.toggle("hidden", v !== "ZERO");

    if(v==="ZERO"){
      renderZeroStock();
      document.getElementById("rightTitle").textContent = "Zero Stock Items";
      document.getElementById("rightSub").textContent = "Qty = 0.";
    } else {
      ensureCategorySelected(false);
      renderCategoryBar();
      renderMain();
      document.getElementById("rightTitle").textContent = "Items (Editable)";
      document.getElementById("rightSub").textContent = "Copy deducts Qty (-1).";
    }
  }

  // =========================================
  // CATEGORY BAR
  // =========================================
  function ensureCategorySelected(forceReset=false){
    const cats = getCategoriesCount();
    if(!cats.size){
      selectedCategory = "__ALL__";
      setSelectedPill();
      return;
    }
    if(forceReset || !selectedCategory || (selectedCategory!=="__ALL__" && !cats.has(selectedCategory))){
      selectedCategory = "__ALL__";
    }
    setSelectedPill();
  }

  function setSelectedPill(){
    const pill = document.getElementById("pillSelected");
    const label = (selectedCategory==="__ALL__") ? "All" : (selectedCategory || "‚Äî");
    pill.textContent = "STOCK ‚Ä¢ " + label;
  }

  function getCategoriesCount(){
    const map = new Map();
    for(const it of items){
      const c = it.category || "Uncategorized";
      map.set(c, (map.get(c)||0) + 1);
    }
    return map;
  }

  function renderCategoryBar(){
    const bar = document.getElementById("catBar");
    bar.innerHTML = "";

    const map = getCategoriesCount();
    const cats = Array.from(map.entries()).sort((a,b)=>b[1]-a[1]);

    // ALL
    {
      const active = selectedCategory === "__ALL__";
      const btn = document.createElement("button");
      btn.className = "flex items-center gap-2 px-3 py-2 rounded-2xl border font-extrabold whitespace-nowrap transition";
      btn.style.background = active ? "rgba(255,255,255,0.12)" : "rgba(255,255,255,0.06)";
      btn.style.borderColor = "rgba(255,255,255,0.18)";
      btn.style.boxShadow = active
        ? "0 0 0 2px rgba(255,255,255,0.25), 0 10px 35px rgba(0,0,0,0.28)"
        : "0 10px 28px rgba(0,0,0,0.22)";
      btn.innerHTML = `
        <span class="text-[18px]">üóÇÔ∏è</span>
        <span class="max-w-[260px] truncate">All</span>
        <span class="text-xs px-2 py-1 rounded-full border border-white/15 bg-black/20 text-slate-100/90">${map.size}</span>
      `;
      btn.onclick = () => {
        selectedCategory = "__ALL__";
        setSelectedPill();
        renderCategoryBar();
        renderMain();
      };
      bar.appendChild(btn);
    }

    for(const [cat,count] of cats){
      const active = cat === selectedCategory;
      const st = hashStyleForCategory(cat);

      const btn = document.createElement("button");
      btn.className = "flex items-center gap-2 px-3 py-2 rounded-2xl border font-extrabold whitespace-nowrap transition";
      btn.style.background = active ? "rgba(255,255,255,0.12)" : st.bg;
      btn.style.borderColor = st.bd;
      btn.style.boxShadow = active
        ? `0 0 0 2px ${st.glow}, 0 10px 35px rgba(0,0,0,0.28)`
        : `0 10px 28px rgba(0,0,0,0.22)`;

      btn.innerHTML = `
        <span class="text-[18px]">${stickerForCategory(cat)}</span>
        <span class="max-w-[260px] truncate">${escapeHtml(cat)}</span>
        <span class="text-xs px-2 py-1 rounded-full border border-white/15 bg-black/20 text-slate-100/90">${count}</span>
      `;

      btn.onclick = () => {
        selectedCategory = cat;
        setSelectedPill();
        renderCategoryBar();
        renderMain();
      };

      bar.appendChild(btn);
    }
  }

  // =========================================
  // ITEMS VIEW
  // =========================================
  function clearSearch(){
    document.getElementById("searchBox").value = "";
    renderMain();
  }

  function buildCategoryOptions(currentCat){
    const cats = Array.from(getCategoriesCount().keys()).sort((a,b)=>a.localeCompare(b));
    // always include basic buckets
    if(!cats.includes("Uncategorized")) cats.unshift("Uncategorized");
    if(!cats.includes("Other / Review")) cats.push("Other / Review");

    const cur = String(currentCat || "").trim() || "Uncategorized";
    let html = "";
    for(const c of cats){
      const sel = (c === cur) ? "selected" : "";
      html += `<option value="${escapeHtml(c)}" ${sel}>${escapeHtml(c)}</option>`;
    }
    return html;
  }

  function changeItemCategory(itemKeyStr, newCategory, badgeId){
    const it = items.find(x => itemKey(x) === itemKeyStr);
    if(!it) return;

    const oldCat = String(it.category || "Uncategorized");
    it.category = String(newCategory || "Uncategorized").trim() || "Uncategorized";
    persistState();

    // If user is currently filtering by the old category, switch to the new one
    if(selectedCategory === oldCat) selectedCategory = it.category;

    // keep selected category valid
    ensureCategorySelected(false);
    renderCategoryBar();
    renderMain();
    renderZeroStock();
    if(!document.getElementById("orgModal").classList.contains("hidden")){
      renderOrganizer();
      showOrgSaved();
    }

    if(badgeId) showSavedBadge(badgeId);
    toast("Saved ‚úÖ");
  }

  function showSavedBadge(badgeId){
    const el = document.getElementById(badgeId);
    if(!el) return;
    el.classList.remove("hidden");
    el.classList.add("animate-pulse");
    setTimeout(() => {
      el.classList.add("hidden");
      el.classList.remove("animate-pulse");
    }, 1200);
  }

  function renderMain(){
    if(currentView !== "ITEMS") return;

    const body = document.getElementById("itemsBody");
    const empty = document.getElementById("emptyState");
    body.innerHTML = "";

    if(!items.length){
      empty.classList.remove("hidden");
      empty.textContent = "Upload stock file to load items.";
      return;
    }

    const q = norm(document.getElementById("searchBox").value);

    let filtered = [];
    if(q){
      filtered = items.filter(it => {
        const name = norm(it.name);
        const code = norm(it.code);
        const cat  = norm(it.category || "");
        return name.includes(q) || code.includes(q) || cat.includes(q);
      });
      // sort by category then name
      filtered.sort((a,b) => {
        const ca = String(a.category||"").localeCompare(String(b.category||""));
        if(ca !== 0) return ca;
        return String(a.name||"").localeCompare(String(b.name||""));
      });
    } else {
      if(selectedCategory === "__ALL__"){
        filtered = items.slice();
      } else {
        filtered = items.filter(it => (it.category || "Uncategorized") === selectedCategory);
      }
    }

    if(!filtered.length){
      empty.classList.remove("hidden");
      empty.textContent = "No items found.";
      return;
    }
    empty.classList.add("hidden");

    for(let i=0;i<filtered.length;i++){
      const it = filtered[i];
      const key = itemKey(it);
      const fav = favSet.has(key);

      const catName = it.category || "Uncategorized";
      const catStyle = hashStyleForCategory(catName);
      const badgeId = `saved_${i}_${Math.random().toString(16).slice(2)}`;

      const catPill = q
        ? `<span class="ml-2 text-[11px] px-2 py-0.5 rounded-full border font-extrabold"
                 style="background:${catStyle.bg}; border-color:${catStyle.bd};">
              ${stickerForCategory(catName)} ${escapeHtml(catName)}
           </span>`
        : "";

      const qty = Number(it.qty ?? 0);
      const cls = qty <= 0
        ? "border-rose-400/40 bg-rose-500/10 text-rose-100"
        : "border-emerald-400/40 bg-emerald-500/10 text-emerald-100";

      const tr = document.createElement("tr");
      tr.className = "border-b border-white/10 hover:bg-white/5";
      tr.innerHTML = `
        <td class="py-2 px-2"><span class="text-[18px]">${stickerForItem(it)}</span></td>

        <td class="py-2 px-2">
          <button class="w-9 h-9 rounded-xl border ${fav ? "border-pink-400/40 bg-pink-500/15" : "border-white/10 bg-white/5"} hover:bg-white/10 flex items-center justify-center"
                  title="Favorite"
                  onclick='toggleFavorite(${JSON.stringify(key)})'>
            <span class="text-[16px]">${fav ? "‚ù§Ô∏è" : "ü§ç"}</span>
          </button>
        </td>

        <td class="py-2 px-2 font-extrabold font-mono text-slate-100/90">${escapeHtml(it.code || "")}</td>

        <td class="py-2 px-2 font-semibold text-slate-100">
          ${escapeHtml(it.name || "")}
          ${catPill}
        </td>

        <td class="py-2 px-2">
          <div class="flex items-center gap-2">
            <select class="w-full text-xs px-3 py-2 rounded-2xl border border-white/10 bg-black/30 font-extrabold"
                    onchange="changeItemCategory(${JSON.stringify(key)}, this.value, ${JSON.stringify(badgeId)})">
              ${buildCategoryOptions(catName)}
            </select>

            <span id="${badgeId}" class="hidden text-xs px-2 py-1 rounded-full border border-emerald-400/40 bg-emerald-500/10 text-emerald-100 font-extrabold">
              Saved ‚úÖ
            </span>
          </div>
        </td>

        <td class="py-2 px-2">
          <span class="inline-flex min-w-[52px] justify-center px-2 py-1 rounded-full border ${cls} font-extrabold">
            ${Number.isFinite(qty) ? qty : 0}
          </span>
        </td>

        <td class="py-2 px-2">
          <button class="px-3 py-2 rounded-xl border border-blue-400/30 bg-blue-500/15 hover:bg-blue-500/20 font-extrabold"
                  onclick='copyAndDeduct(${JSON.stringify(key)})'>
            Copy
          </button>
        </td>
      `;
      body.appendChild(tr);
    }
  }

  // =========================================
  // COPY + DEDUCT + UNDO
  // =========================================
  async async function copyAndDeduct(key){
    const it = items.find(x => itemKey(x) === key);
    if(!it){ toast("Item not found"); return; }

    const text = String(it.code || it.name || "").trim();
    if(!text){ toast("Nothing to copy"); return; }

    // copy first
    try{
      await navigator.clipboard.writeText(text);
    }catch(e){
      // fallback: do nothing (still deduct)
    }

    const prev = Number(it.qty ?? 0);
    const next = Math.max(0, prev - 1);
    it.qty = next;

    undoStack.push({ key, prevQty: prev, newQty: next, atISO: new Date().toISOString() });
    if(undoStack.length > 50) undoStack.shift();

    persistState();
    updateUndoBtn();

    // refresh views
    renderMain();
    renderZeroStock();
    if(!document.getElementById("orgModal").classList.contains("hidden")) renderOrganizer();

    toast(`Copied: ${text} ‚Ä¢ Qty: ${prev} ‚Üí ${next}`);
  }

  function undoLast(){
    if(!undoStack.length){ return; }
    const act = undoStack.pop();
    const it = items.find(x => itemKey(x) === act.key);
    if(it) it.qty = Number(act.prevQty ?? it.qty ?? 0);

    persistState();
    updateUndoBtn();
    renderMain();
    renderZeroStock();
    if(!document.getElementById("orgModal").classList.contains("hidden")) renderOrganizer();

    toast("Undo ‚úÖ");
  }

  // =========================================
  // ZERO STOCK
  // =========================================
  function getZeroStock(){
    return items.filter(it => Number(it.qty ?? 0) === 0);
  }

  function renderZeroStock(){
    const list = getZeroStock();
    document.getElementById("zeroCountBadge").textContent = String(list.length);

    const body = document.getElementById("zeroBody");
    const empty = document.getElementById("zeroEmpty");
    body.innerHTML = "";

    if(!items.length){
      empty.classList.remove("hidden");
      empty.textContent = "Upload stock file first.";
      return;
    }

    if(!list.length){
      empty.classList.remove("hidden");
      empty.textContent = "No zero-stock items.";
      return;
    }
    empty.classList.add("hidden");

    for(const it of list){
      const tr = document.createElement("tr");
      tr.className = "border-b border-white/10 hover:bg-white/5";
      tr.innerHTML = `
        <td class="py-2 px-2"><span class="text-[18px]">üü•</span></td>
        <td class="py-2 px-2 font-extrabold">${escapeHtml(it.category || "Uncategorized")}</td>
        <td class="py-2 px-2 font-extrabold font-mono">${escapeHtml(it.code || "")}</td>
        <td class="py-2 px-2 font-semibold">${escapeHtml(it.name || "")}</td>
        <td class="py-2 px-2">
          <button class="px-3 py-2 rounded-xl border border-blue-400/30 bg-blue-500/15 hover:bg-blue-500/20 font-extrabold"
                  onclick='copyOnly(${JSON.stringify(it.code || it.name || "")})'>Copy</button>
        </td>
      `;
      body.appendChild(tr);
    }
  }

  async function copyOnly(text){
    const t = String(text||"").trim();
    if(!t){ toast("Nothing to copy"); return; }
    try{ await navigator.clipboard.writeText(t); }catch(e){}
    toast("Copied: " + t);
  }

  // =========================================
  // FAVORITES
  // =========================================
  function toggleFavorite(key){
    if(favSet.has(key)) favSet.delete(key);
    else favSet.add(key);
    persistState();
    toast(favSet.has(key) ? "Added to favorites" : "Removed from favorites");
    renderMain();
    if(!document.getElementById("favPanel").classList.contains("hidden")) renderFavorites();
    if(!document.getElementById("orgModal").classList.contains("hidden")) renderOrganizer();
  }

  function toggleFavoritesPanel(){
    const p = document.getElementById("favPanel");
    p.classList.toggle("hidden");
    renderFavorites();
  }

  function renderFavorites(){
    const list = document.getElementById("favList");
    const q = norm(document.getElementById("favSearch").value);
    list.innerHTML = "";

    const favItems = items.filter(it => favSet.has(itemKey(it)))
      .filter(it => {
        if(!q) return true;
        return norm(it.name).includes(q) || norm(it.code).includes(q) || norm(it.category).includes(q);
      })
      .sort((a,b) => String(a.name||"").localeCompare(String(b.name||"")));

    if(!favItems.length){
      list.innerHTML = `<div class="text-slate-300 font-semibold">No favorites yet.</div>`;
      return;
    }

    for(const it of favItems){
      const key = itemKey(it);
      const st = hashStyleForCategory(it.category || "Uncategorized");
      const card = document.createElement("div");
      card.className = "rounded-2xl border border-white/10 bg-white/5 p-3";
      card.innerHTML = `
        <div class="flex items-start justify-between gap-2">
          <div class="min-w-0">
            <div class="font-extrabold truncate">${escapeHtml(it.name || "")}</div>
            <div class="text-xs text-slate-300 font-semibold mt-1 truncate">
              <span class="px-2 py-0.5 rounded-full border" style="background:${st.bg}; border-color:${st.bd};">
                ${stickerForCategory(it.category || "Uncategorized")} ${escapeHtml(it.category || "Uncategorized")}
              </span>
              <span class="ml-2 font-mono">${escapeHtml(it.code || "")}</span>
              <span class="ml-2">Qty: <span class="font-extrabold text-slate-100">${Number(it.qty ?? 0)}</span></span>
            </div>
          </div>
          <button class="w-9 h-9 rounded-xl border border-pink-400/40 bg-pink-500/15 hover:bg-pink-500/20 flex items-center justify-center"
                  onclick='toggleFavorite(${JSON.stringify(key)})' title="Remove favorite">
            ‚ù§Ô∏è
          </button>
        </div>
        <div class="mt-2 flex gap-2">
          <button class="px-3 py-2 rounded-xl border border-blue-400/30 bg-blue-500/15 hover:bg-blue-500/20 font-extrabold"
                  onclick='copyAndDeduct(${JSON.stringify(key)})'>Copy (-1)</button>
          <button class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 font-extrabold"
                  onclick='focusItem(${JSON.stringify(key)})'>Show</button>
        </div>
      `;
      list.appendChild(card);
    }
  }

  function focusItem(key){
    // jump to items view and highlight by search
    switchView("ITEMS");
    const it = items.find(x => itemKey(x) === key);
    if(it){
      document.getElementById("searchBox").value = it.code || it.name || "";
      selectedCategory = "__ALL__";
      renderCategoryBar();
      renderMain();
    }
  }

  // =========================================
  // ORGANIZER
  // =========================================
  function openOrganizer(){
    document.getElementById("orgModal").classList.remove("hidden");
    if(!orgSelectedCategory){
      // select the biggest category
      const map = getCategoriesCount();
      const best = Array.from(map.entries()).sort((a,b)=>b[1]-a[1])[0];
      orgSelectedCategory = best ? best[0] : "Uncategorized";
    }
    renderOrganizer();
  }
  function closeOrganizer(){
    document.getElementById("orgModal").classList.add("hidden");
  }

  function addCategory(){
    const name = prompt("New category name:");
    if(!name) return;
    const n = String(name).trim();
    if(!n) return;

    // if exists, just select
    const exists = Array.from(getCategoriesCount().keys()).some(c => c.toLowerCase() === n.toLowerCase());
    if(!exists){
      // create by adding an empty marker item? No: just keep category available via option lists.
      // We add a hidden "category marker" record in localStorage meta list.
      // Simpler: we keep categories via a special list in meta.
      const meta = safeJson(localStorage.getItem(LS_META)) || {};
      meta.userCategories = meta.userCategories || [];
      if(!meta.userCategories.some(c => String(c).toLowerCase() === n.toLowerCase())) meta.userCategories.push(n);
      localStorage.setItem(LS_META, JSON.stringify(meta));
    }

    orgSelectedCategory = n;
    renderOrganizer();
    renderMain();
    renderCategoryBar();
    toast("Category added");
  }

  function renameCategory(oldName){
    const nn = prompt("Rename category:", oldName);
    if(!nn) return;
    const newName = String(nn).trim();
    if(!newName || newName === oldName) return;

    for(const it of items){
      if((it.category || "Uncategorized") === oldName) it.category = newName;
    }

    // also update userCategories list
    const meta = safeJson(localStorage.getItem(LS_META)) || {};
    if(meta.userCategories){
      meta.userCategories = meta.userCategories.map(c => (c === oldName ? newName : c));
      localStorage.setItem(LS_META, JSON.stringify(meta));
    }

    if(selectedCategory === oldName) selectedCategory = newName;
    if(orgSelectedCategory === oldName) orgSelectedCategory = newName;

    persistState();
    renderCategoryBar();
    renderMain();
    renderOrganizer();
    toast("Category renamed");
  }

  function deleteCategory(cat){
    const ok = confirm(`Delete category "${cat}"?\n\nItems will be moved to "Uncategorized".`);
    if(!ok) return;

    for(const it of items){
      if((it.category || "Uncategorized") === cat) it.category = "Uncategorized";
    }

    const meta = safeJson(localStorage.getItem(LS_META)) || {};
    if(meta.userCategories){
      meta.userCategories = meta.userCategories.filter(c => c !== cat);
      localStorage.setItem(LS_META, JSON.stringify(meta));
    }

    if(selectedCategory === cat) selectedCategory = "__ALL__";
    if(orgSelectedCategory === cat) orgSelectedCategory = "Uncategorized";

    persistState();
    renderCategoryBar();
    renderMain();
    renderOrganizer();
    toast("Category deleted");
  }

  function getAllCategoryNames(){
    const set = new Set(Array.from(getCategoriesCount().keys()));
    // include user-added categories even if empty
    const meta = safeJson(localStorage.getItem(LS_META)) || {};
    (meta.userCategories || []).forEach(c => set.add(c));
    // ensure basics
    set.add("Uncategorized");
    set.add("Other / Review");
    return Array.from(set).filter(Boolean).sort((a,b)=>a.localeCompare(b));
  }

  function renderOrganizer(){
    const catQ = norm(document.getElementById("orgCatSearch").value);
    const itemQ = norm(document.getElementById("orgItemSearch").value);

    // categories
    const list = document.getElementById("orgCatList");
    list.innerHTML = "";
    const cats = getAllCategoryNames()
      .filter(c => !catQ || norm(c).includes(catQ));

    for(const c of cats){
      const count = getCategoriesCount().get(c) || 0;
      const active = c === orgSelectedCategory;
      const st = hashStyleForCategory(c);

      const card = document.createElement("div");
      card.className = "rounded-2xl border p-3 cursor-pointer";
      card.style.background = active ? "rgba(255,255,255,0.10)" : st.bg;
      card.style.borderColor = st.bd;

      card.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div class="min-w-0">
            <div class="font-extrabold truncate"><span class="mr-1">${stickerForCategory(c)}</span>${escapeHtml(c)}</div>
            <div class="text-xs text-slate-300 font-semibold mt-1">Items: <span class="text-slate-100 font-extrabold">${count}</span></div>
          </div>
          <div class="flex gap-2">
            <button class="px-2 py-1 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 font-extrabold text-xs"
                    onclick="event.stopPropagation(); renameCategory(${JSON.stringify(c)})">Rename</button>
            <button class="px-2 py-1 rounded-xl border border-rose-400/30 bg-rose-500/10 hover:bg-rose-500/15 font-extrabold text-xs"
                    onclick="event.stopPropagation(); deleteCategory(${JSON.stringify(c)})">Delete</button>
          </div>
        </div>
      `;
      card.onclick = () => {
        orgSelectedCategory = c;
        renderOrganizer();
      };
      list.appendChild(card);
    }

    // selected category title
    document.getElementById("orgCatTitle").textContent = orgSelectedCategory || "‚Äî";

    // items in selected category
    const body = document.getElementById("orgItemsBody");
    const empty = document.getElementById("orgEmpty");
    body.innerHTML = "";

    const currentCat = orgSelectedCategory || "Uncategorized";
    let its = items.filter(it => (it.category || "Uncategorized") === currentCat);

    if(itemQ){
      its = its.filter(it => norm(it.name).includes(itemQ) || norm(it.code).includes(itemQ));
    }

    if(!its.length){
      empty.classList.remove("hidden");
      return;
    }
    empty.classList.add("hidden");

    // sort by name
    its.sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));

    const moveCats = getAllCategoryNames();

    for(const it of its){
      const key = itemKey(it);
      const fav = favSet.has(key);

      const options = moveCats.map(c => `<option value="${escapeHtml(c)}" ${c===currentCat?"selected":""}>${escapeHtml(c)}</option>`).join("");

      const tr = document.createElement("tr");
      tr.className = "border-b border-white/10 hover:bg-white/5";
      tr.innerHTML = `
        <td class="py-2 px-2">
          <button class="w-9 h-9 rounded-xl border ${fav ? "border-pink-400/40 bg-pink-500/15" : "border-white/10 bg-white/5"} hover:bg-white/10 flex items-center justify-center"
                  onclick='toggleFavorite(${JSON.stringify(key)})'
                  title="Favorite">
            <span class="text-[16px]">${fav ? "‚ù§Ô∏è" : "ü§ç"}</span>
          </button>
        </td>
        <td class="py-2 px-2 font-extrabold font-mono">${escapeHtml(it.code || "")}</td>
        <td class="py-2 px-2 font-semibold">${escapeHtml(it.name || "")}</td>
        <td class="py-2 px-2 font-extrabold">${Number(it.qty ?? 0)}</td>
        <td class="py-2 px-2">
          <select class="w-full text-xs px-3 py-2 rounded-2xl border border-white/10 bg-black/30 font-extrabold"
                  onchange="changeItemCategory(${JSON.stringify(key)}, this.value, '')">
            ${options}
          </select>
        </td>
      `;
      body.appendChild(tr);
    }
  }

  // =========================================
  // EXPORT (Excel + PDF)
  // =========================================
  function exportAllExcel(){
    if(!items.length){ toast("No data"); return; }
    const rows = items.map(it => ({
      Category: it.category || "Uncategorized",
      ItemCode: it.code || "",
      ItemName: it.name || "",
      Qty: Number(it.qty ?? 0)
    }));
    exportExcel(rows, "ICU_Stock_All.xlsx");
  }

  function exportZeroExcel(){
    if(!items.length){ toast("No data"); return; }
    const rows = getZeroStock().map(it => ({
      Category: it.category || "Uncategorized",
      ItemCode: it.code || "",
      ItemName: it.name || "",
      Qty: Number(it.qty ?? 0)
    }));
    exportExcel(rows, "ICU_Stock_Zero.xlsx");
  }

  function exportExcel(rows, filename){
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Stock");
    XLSX.writeFile(wb, filename);
    toast("Exported ‚úÖ");
  }

  function exportAllPDF(){ exportPDF(items, "ICU_Stock_All.pdf"); }
  function exportZeroPDF(){ exportPDF(getZeroStock(), "ICU_Stock_Zero.pdf"); }

  function exportPDF(list, filename){
    if(!list.length){ toast("No data"); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "landscape" });

    const rows = list.map(it => [
      it.category || "Uncategorized",
      it.code || "",
      it.name || "",
      String(Number(it.qty ?? 0))
    ]);

    doc.setFontSize(12);
    doc.text("ICU Stock Dashboard", 14, 12);
    doc.setFontSize(10);
    doc.text(`Exported: ${new Date().toLocaleString()}`, 14, 18);

    doc.autoTable({
      head: [["Category", "Item Code", "Item Name", "Qty"]],
      body: rows,
      startY: 24,
      styles: { fontSize: 8 },
      headStyles: { fillColor: [30, 41, 59] },
      theme: "grid"
    });

    doc.save(filename);
    toast("Exported ‚úÖ");
  }

  // =========================================
  // BACKUP / RESTORE
  // =========================================
  function downloadBackupJson(){
    const meta = safeJson(localStorage.getItem(LS_META)) || null;
    const payload = {
      version: 2,
      exportedAtISO: new Date().toISOString(),
      meta,
      items,
      favorites: Array.from(favSet),
      undoStack
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "ICU_Stock_Backup.json";
    a.click();
    URL.revokeObjectURL(a.href);
    toast("Backup downloaded");
  }

  async function restoreBackupJson(file){
    if(!file) return;
    try{
      const text = await file.text();
      const payload = JSON.parse(text);

      if(!payload || !Array.isArray(payload.items)){
        toast("Invalid backup file");
        return;
      }

      items = payload.items || [];
      favSet = new Set(payload.favorites || []);
      undoStack = payload.undoStack || [];

      localStorage.setItem(LS_META, JSON.stringify(payload.meta || {}));
      persistState();
      updateUndoBtn();
      updateLastMetaUI();

      selectedCategory = "__ALL__";
      ensureCategorySelected(true);
      renderCategoryBar();
      renderMain();
      renderZeroStock();

      toast("Restored ‚úÖ");
    }catch(e){
      toast("Restore failed");
    }finally{
      document.getElementById("restoreJsonFile").value = "";
    }
  }

  function resetLocalData(){
    const ok = confirm("Reset local data?\nThis will remove items, quantities, categories, and undo history from this browser.");
    if(!ok) return;

    localStorage.removeItem(LS_ITEMS);
    localStorage.removeItem(LS_META);
    localStorage.removeItem(LS_UNDO);
    // keep favorites? user asked keep favorite list same -> we keep it
    // localStorage.removeItem(LS_FAV);

    loadState();
    updateLastMetaUI();
    selectedCategory = "__ALL__";
    renderCategoryBar();
    renderMain();
    renderZeroStock();

    toast("Reset done");
  }

  // =========================================
  // INIT
  // =========================================
  (function init(){
    loadState();
    updateLastMetaUI();
    ensureCategorySelected(true);
    renderCategoryBar();
    renderMain();
    renderZeroStock();
    setStatus("Ready");
  })();
</script>

</body>
</html>
